
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="./Clean.js"></script>
    <script defer src="compile.js"></script>
    <script type="module" defer src="./hub.js"></script>
    <script defer src="filesys.js"></script> -->
    <script type="module" src="./app.js"></script>
    <link rel="stylesheet" href="../styles/style.sass">
    <title>Clean App</title>
</head>
<body>

    <!-- <Header id=Header init="{asd: 'asdfsadf'}" traps="asdf" ></Header>
    <!-- <Home id='Home, mate'></Home> -->
    <!-- <ChangeStateButton id="btn_-2234"></ChangeStateButton> -->
    <!-- <MyList id="MyList" init="" traps="" link=""></MyList>
        <BinManager id="" init="{[fluffy, charles], 23, 'Jimmy Neutron'[fluffy, charles], 23, 'Jimmy Neutron'[fluffy, charles], 23, 'Jimmy Neutron'}," traps=""></BinManager>
        <!--<Bin id="Bin_
            ssdf
        23"></Bin> -->
        <!-- <Movie id="Movie_5"></Movie> -->
    <!-- </MyList> -->
    <!-- <Footer id=""></Footer> -->

</body>
<script>
    // Put code to load first here
    class Store {
        constructor (concern, script, init={}, traps={}, push=null) {
            // if (concern) {console.log(true)} else console.log(false);
            // if (!now) {console.log(true)} else console.log(false);
            // if (now) now.legacy
            // if (now && !Object.keys(now.legacy).includes(concern)) {console.log(true)} else console.log(false);
            this._concern = concern;
            // } else throw new Error('Stores must be initialized with a concern');
            if (concern === 'app') {
                this.legacy = {test: ''};
                this._dynasty = { app: {} }
            } else now.legacy = now._dynasty = concern;
            this._diff = {};
            this._init = init;
            this.state = {};
            this.links = {};
            this._script = script;
            this._fragment = new DocumentFragment();

            if (Object.entries(init).length) {
                for (let entry in init) { this.state[entry] = init[entry] }
            };

            const handler = {
                get: (target, property, self) => {
                    if (property === 'check') Reflect.get(target, property, self)
                    if (['CHECK _concern', 'CHECK _diff', 'CHECK _init', 'CHECK state', 'CHECK legacy', 'CHECK _dynasty', 'CHECK links'].includes(property)) console.log(target[property]);
                    if (property === 'CHECK target') console.log(target);
                    if (property in this._diff) { delete this._diff[property] }
                    return ['_concern', '_diff', '_init', 'state', '__clear__', 'check', 'toggle', 'link', 'links', '_fragment'].includes(property) ? target[property] : Reflect.get(target.state, property, self)
                },
                set: (target, property, value, self) => {
                    if ('concern,diff,init,state'.match(property.replace(/_/g, '').toLowerCase())) {
                        console.log('State items may not resemble top-level properties')
                    } else {
                        if (property === '_dynasty') { target._dynasty[/*document.querySelector('part').getAttribute('parent')*/'app'][value] = {}; true }
                        if (property === 'legacy') { this.legacy[value] = {}; true }
                        if (property === 'legacyExtension') { this.legacy[value[0]] = value[1]; true }
                        if (property === 'onClear') { now.legacyExtension = [this._concern, value]; true
                        } else this._diff[property] = this.state[property] = value;
                        this.render();
                    }
                    return true;
                }
            };

            const handlerInsert = (trap, plus) => {
                let value = handler[trap];
                value = `${value}`.split('return');
                value.splice(1, 0, 'return');
                value.splice(1, 0, plus);
                value.unshift('(');
                value.push(')');
                handler[trap] = eval(value.join(''));
            }
            
            if (Object.entries(traps).length) {
                for (let trap in traps) { 
                    if (trap === 'set' || trap === 'get') {
                        handlerInsert(trap, `${traps[trap]}`);
                    } else handler[trap] = eval(traps[trap]);
                }
                if (push) {
                    for (trap in handler) {
                        handlerInsert(trap, `\nif (this._diff.length) {
                            for (let property in this._diff) { push[property] = this._diff[property] }
                        }\n`);
                    }
                }
            }

            return new Proxy(this, handler)
        };

        check(what) { what ? this['CHECK '+what] : this['CHECK target'] };

        link(state, ...observers) { 
            if (!this.links[state]) this.links[state] = [];
            observers.forEach(observer => this.links[state].push([`[part='${this._concern}'] ${observer[0]}`, observer[1]]))
        };

        toggle(etarget, state, state1, state2, event='click') { 
            document.querySelector(`[part='${this._concern}'] ${etarget}`).addEventListener(event, _=> this[state] = (this[state] === state1) ? state2 : state1)
        };

        render() {
            if (this._concern !== 'app') {
                let part = document.querySelector(`[part='${this._concern}']`),
                    clone = part.cloneNode('deep');
                this._fragment.appendChild(clone);
                for (let diff in this._diff) {
                    if (diff in this.links) {
                        this.links[diff].forEach(link => this._fragment.querySelector(link[0])[link[1]] = this._diff[diff]);
                    }
                }
                part.replaceWith(this._fragment);
                this._script();
            }
            return true;
        };

        __clear__() {
            for (let property in this.state) { delete this.state[property] }
            if (Object.entries(now.legacy[this._concern]).length) {
                for (let property in now.legacy[this._concern]) { this[property] = now.legacy[this._concern][property] }
            }
        };
        
        __fullclear__() {
            for (let property in this.state) { delete this.state[property] }
            if (Object.entries(this._init).length) {
                for (let property in this._init) { this[property] = this._init[property] }
            }
        }
    };

    const now = new Store('app');

    // const partCounts = {
    //     Home: 0,
    //     Header: 1
    // };

//     const Home = (init={}, traps={}) => {
//         const instance = (_=> {
//             const partName = `Home${partCounts.Home ? ' '+partCounts.Home : ''}`;
//             partCounts.Home++;
//             let newElt = document.createElement('Home');
//             newElt.setAttribute('part', partName);
//             newElt.setAttribute('id', 'Home, mate');
//             newElt.innerHTML = homeContent(init)`<div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#ddd" fill-opacity="1" d="M0,160L48,138.7C96,117,192,75,288,58.7C384,43,480,53,576,85.3C672,117,768,171,864,197.3C960,224,1056,224,1152,192C1248,160,1344,96,1392,64L1440,32L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg></div>
// <h1 id="title">Welcome to CleanJS</h1>
// <ChangeStateButton id="homeStateBtn"><button id="changeStateBtn"></button>
// <Footer id="newHome"><div id="footerDiv">and your <strong>footer</strong> last</div></Footer></ChangeStateButton>
// <div id="lowerSvg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 319"><path fill="#7a7aa3" fill-opacity="1" d="M0,160L48,138.7C96,117,192,75,288,58.7C384,43,480,53,576,85.3C672,117,768,171,864,197.3C960,224,1056,224,1152,192C1248,160,1344,96,1392,64L1440,32L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg></div>`;
//             document.body.appendChild(newElt);
//             // console.log(document.querySelector(`[part='${partName}']`))            
//             const script = _=> {
//                 store.toggle('#title', 'titleText', 'Enjoy your stay', 'Welcome to CleanJS');
//                 store.link('titleText', ['#title', 'textContent']);
//             },
            
//             store = new Store(partName, script, init, traps);
//             script();
//             return script;
//         })();
//         return instance;
//     };
//     Home();
//     Home();
//     Home();



</script>
<script defer>
    // Put code to load last here

    // class Private {
    //     constructor(init, setOn) {

    //         if (typeof(setOn) === 'undefined') throw new Error('Private variables must be initialized with set conditions')
    //         this.value = typeof(init === 'object') ? {is: {}} : {is: ''};

    //         if (typeof(init) === 'object') {
    //             if (init === null) {
    //                 this.value.is = null;
    //             } else {
    //                 if (Object.entries(init).length) { for (let entry in init) this.value.is[entry] = init[entry] }
    //             }
    //         } else this.value.is = init;

    //         const handler = {
    //             get: (target, property, self) => {
    //                 if (typeof(target.value.is) !== 'object' || Array.isArray(target.value.is)) { return property === 'value' ? Reflect.get(target.value, 'is') : Reflect.get(target.value.is, property)
    //                 } else {
    //                     return Reflect.get(target.value.is, property);
    //                 }
    //             },
    //             set: (target, property, assignment) => {
    //                 console.log('setting', property, 'to', assignment)
    //                 if (setOn) {
    //                     if (property === 'value') { 
    //                         if (typeof(assignment) === 'object' && !Array.isArray(assignment)) {
    //                             if (typeof(target.value.is) !== 'object' || Array.isArray(target.value.is)) target.value.is = {};
    //                             let val;
    //                             let something = [];
    //                             // do {
    //                             //     for (let entry in assignment) {
    //                             //         new Proxy({value: {is: val}}, handler);
                                        
    //                             //     }
    //                             // } while (typeof(val) === 'object' || !Array.isArray(target.value.is));
    //                             Reflect.set(target.value.is, entry, newProxy);
    //                         } else return Reflect.set(target.value, 'is', assignment)
    //                     } else {
    //                         if (typeof(target.value.is) !== 'object' || Array.isArray(target.value.is)) target.value.is = {};
                            
    //                         return Reflect.set(target.value.is, property, new Proxy({value: {is: assignment}}, handler))
    //                     }
    //                 }
    //             }
    //         }
    //         return new Proxy(this, handler)
    //     };

        // read(from) { }
    // };
    
    // let privVar = new Private({a: {b: 25}}, true);
    // privVar.a.b = {c: 'l3', c2: 'l3p2'};
    // privVar.b = {d: {e: 'f'}, g: {h: 90, q: {p: [4,'hoho', null]}}};
    // // console.log(privVar)
</script>
<!-- <script type="module" src="../scripts/Modules.js"></script>
<script type="module" src="hub.js"> -->
<!-- </script> -->
<!-- <script type="module" src="../test2.js"></script> -->
<!-- <script type="module">
    import {sayHi} from '../scripts/Modules.js';
    console.log('working');
    sayHi(); -->
<!-- </script> -->
<!-- <script src='../test.js'></script> -->
</body>
</html>