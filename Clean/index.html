<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./Clean.js"></script>
    <script defer src="./hub.js"></script>
    <script defer src="../scripts/Modules.js"></script>
    <link rel="stylesheet" href="../styles/style.sass">
    <title>Clean App</title>
</head>
<body>
    <script>
        class Store {
            constructor (concern, init={}, traps={}, push=null) {
                if (concern) { this._concern = concern 
                } else throw new Error('Stores must be initialized with a concern');
                this._diff = {};
                this._init = init;
                this.state = {};

                if (Object.entries(init).length) {
                    for (let entry in init) { this.state[entry] = init[entry] }
                };
                const handler = {
                    get: (target, prop, self) => {
                        if (prop in this._diff) { delete this._diff[prop] }
                        return ['_concern', '_diff', '_init', 'state', '__clear__'].includes(prop) ? target[prop] : Reflect.get(target.state, prop, self)
                    },
                    set: (target, prop, value, self) => {
                        if ('concern,diff,init,state'.match(prop.replace(/_/g, '').toLowerCase())) {
                            console.log('State items may not resemble top-level properties')
                        } else this._diff[prop] = this.state[prop] = value;
                        return true;
                    }
                };
                
                if (Object.entries(traps).length) {
                    for (let trap in traps) { 
                        if (trap === 'set' || trap === 'get') {
                            let val = handler[trap];
                            val = `${val}`.split('return');
                            val.splice(1, 0, 'return');
                            val.splice(1, 0, `${traps[trap]}`);
                            val.unshift('(');
                            val.push(')');
                            handler[trap] = eval(val.join(''));
                        } else handler[trap] = eval(traps[trap]);
                    }
                    if (push) {
                        for (trap in handler) {
                            let val = handler[trap];
                            val = `${val}`.split('return');
                            val.splice(1, 0, 'return');
                            val.splice(1, 0, `\nif (this._diff.length) {
                                for (let prop in this._diff) { push[prop] = this._diff[prop] }
                            }\n`);
                            val.unshift('(');
                            val.push(')')
                            handler[trap] = eval(val.join(''));
                        }
                    }
                }

                return new Proxy(this, handler)
            };

            __clear__() {
                for (let prop in this.state) { delete this.state[prop] }
                if (Object.entries(this._init).length) {
                        for (let prop in this._init) { this[prop] = this._init[prop] }
                }
            };
        };

        const now = new Store('app');
    </script>
    <script>
    </script>
</body>
</html>